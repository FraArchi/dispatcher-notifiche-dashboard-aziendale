---
phase: 02-blocking-ui-multimedia
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified: [dispatcher.html, server.js]
autonomous: true
requirements: [FR-3, FR-6]
must_haves:
  truths:
    - "An acoustic alarm loops perfectly without gaps when an alert is active"
    - "Clicking 'Prendi in Carico' notifies the server via Socket.io"
    - "The server logs the ticket acknowledgment"
  artifacts:
    - path: "dispatcher.html"
      provides: "AudioBufferSourceNode alarm logic and Socket.io emission"
    - path: "server.js"
      provides: "Socket.io listener for acknowledgment"
  key_links:
    - from: "dispatcher.html"
      to: "server.js"
      via: "socket.emit('ticket-acknowledged', ...)"
---

<objective>
Implement a high-fidelity gapless looping alarm and synchronize ticket acknowledgment between client and server.

Purpose: Provide an urgent, persistent audio cue and ensure the system records when and by whom a ticket was acknowledged.
Output: Integrated audio system and bidirectional real-time acknowledgment flow.
</objective>

<execution_context>
@/home/laboratorio/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-blocking-ui-multimedia/02-RESEARCH.md
@.planning/phases/02-blocking-ui-multimedia/02-01-SUMMARY.md
@dispatcher.html
@server.js

<interfaces>
From dispatcher.html:
- `state.audioContext`
- `playAlertSound()`
- `handleTakeChargeAction()`

From server.js:
- `io.on('connection', ...)`
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Gapless Looping Alarm</name>
  <files>dispatcher.html</files>
  <action>
    - Refactor `playAlertSound` to use `AudioBufferSourceNode`.
    - Create a short synthesized beep buffer (e.g., 200ms of a 880Hz sine/square wave).
    - Use `source.loop = true` on the `AudioBufferSourceNode`.
    - Ensure the loop points are precise to avoid "clicks" or "silence gaps".
    - Connect to `audioContext.destination` with a `GainNode` for volume control.
    - Implement `stopAlertSound` to properly disconnect and stop the source node.
  </action>
  <verify>Run 'Test Audio' in dispatcher.html. Listen for any gaps or pops in the loop. The sound should be continuous and urgent.</verify>
  <done>Alarm sound loops seamlessly using AudioBufferSourceNode.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Acknowledgment Sync</name>
  <files>dispatcher.html, server.js</files>
  <action>
    - **Client (dispatcher.html):** In `handleTakeChargeAction`, emit a `ticket-acknowledged` event via Socket.io with the ticket GGUID and operator info.
    - **Server (server.js):** Add a listener for `ticket-acknowledged`.
    - Log the acknowledgment to the server console with a timestamp.
    - (Optional) Broadcast to other clients that the ticket is taken (to dismiss their overlays if multi-user).
  </action>
  <verify>Trigger an alert, click 'Prendi in Carico', and check the server console for the 'Ticket [ID] acknowledged by [Operator]' log message.</verify>
  <done>Ticket acknowledgment is communicated to the server and logged.</done>
</task>

</tasks>

<verification>
1. Trigger alert: Does the alarm start looping seamlessly?
2. Click 'Prendi in Carico': Does the alarm stop immediately?
3. Check Server: Is there a log entry for the acknowledgment?
</verification>

<success_criteria>
- Seamless audio loop (no gaps).
- Bidirectional communication for ticket status.
- UI cleanup on acknowledgment.
</success_criteria>

<output>
After completion, create `.planning/phases/02-blocking-ui-multimedia/02-02-SUMMARY.md`
</output>
