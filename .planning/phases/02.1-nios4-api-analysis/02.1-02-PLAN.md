---
phase: 02.1-nios4-api-analysis
plan: 02
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified: [server.js, verify-nios-sdk.js]
autonomous: true
requirements: [FR-1, FR-2]
must_haves:
  truths:
    - "server.js uses Nios4Client for /api/ticket"
    - "Verification script confirms successful API interaction"
  artifacts:
    - path: "verify-nios-sdk.js"
      provides: "End-to-end SDK verification"
  key_links:
    - from: "server.js"
      to: "Nios4Client.js"
      via: "require"
      pattern: "require\(['"]./Nios4Client['"]\)"
---

<objective>
Integrate the Nios4 SDK into the main server and verify the full system connectivity.
This replaces the raw axios calls in the proxy endpoint with the new `Nios4Client`.
</objective>

<execution_context>
@/home/laboratorio/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/02.1-nios4-api-analysis/02.1-01-PLAN.md
@server.js
@.env
</context>

<tasks>

<task type="auto">
  <name>Refactor server.js to use Nios4Client</name>
  <files>server.js</files>
  <action>
    1. Import `Nios4Client` in `server.js`.
    2. Instantiate a global `nios4` client using environment variables (`NIOS4_DB`, `NIOS4_TOKEN`, and base URL `https://web.nios4.com/ws`).
    3. Replace the logic in `app.get('/api/ticket', ...)` with `nios4.find_records('ticket', "stato='Aperto'")`.
    4. Ensure error handling is preserved or improved using the client's responses.
  </action>
  <verify>
    Restart the server and check for initialization errors:
    `npm start` (look for console logs)
  </verify>
  <done>
    `server.js` successfully uses `Nios4Client` for the ticket proxy endpoint.
  </done>
</task>

<task type="auto">
  <name>Create and run verify-nios-sdk.js</name>
  <files>verify-nios-sdk.js</files>
  <action>
    Create a script `verify-nios-sdk.js` that:
    1. Loads `.env`.
    2. Instantiates `Nios4Client`.
    3. Performs a `find_records` on `ticket` table.
    4. Logs the count of records found.
    5. (Optional) Attempts to fetch a single record if any are found.
    6. Exits with 0 on success, 1 on failure.
    
    This script serves as a regression test for the SDK.
  </action>
  <verify>
    Run the script: `node verify-nios-sdk.js`
  </verify>
  <done>
    `verify-nios-sdk.js` confirms that the SDK correctly communicates with the Nios4 API.
  </done>
</task>

</tasks>

<verification>
- `/api/ticket` endpoint on the server returns the expected data.
- `verify-nios-sdk.js` passes without errors.
</verification>

<success_criteria>
- The server is now powered by the `Nios4Client` SDK.
- The project has an automated way to verify Nios4 connectivity.
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-nios4-api-analysis/02.1-02-SUMMARY.md`
</output>
