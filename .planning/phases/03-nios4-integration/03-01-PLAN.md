---
phase: 03-nios4-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [".env", "server.js"]
autonomous: true
requirements: [FR-1, FR-2]

must_haves:
  truths:
    - "Server successfully verifies HMAC signature on incoming webhooks when header is present"
    - "Server maps Nios4 payload fields to internal ticket format"
    - "Polling fallback fetches 'Aperto' tickets at configured intervals"
    - "Deduplication prevents re-notifying the same ticket in the same session"
  artifacts:
    - path: "server.js"
      provides: "Webhook security and polling logic"
    - path: ".env"
      provides: "Configuration for security and polling"
  key_links:
    - from: "server.js (webhook)"
      to: "io.emit('new-ticket')"
      via: "Socket.io"
    - from: "server.js (polling)"
      to: "Nios4Client.find_records"
      via: "API call"
---

<objective>
Enhance the server to handle Nios4 integration securely and reliably. This includes adding signature verification to webhooks, mapping payloads correctly, and implementing a polling fallback for cases where webhooks might fail.

Purpose: Ensure no ticket is missed and that the system only processes authentic requests.
Output: Secure webhook endpoint and background polling service.
</objective>

<execution_context>
@/home/laboratorio/.gemini/get-shit-done/workflows/execute-plan.md
@/home/laboratorio/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server.js
@Nios4Client.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Environment and Webhook Security</name>
  <files>.env, server.js</files>
  <action>
    1. Update `.env` to include:
       - `WEBHOOK_SECRET=your_secret_here`
       - `POLLING_INTERVAL_MS=30000`
       - `ENABLE_POLLING=true`
    2. Refactor `app.post('/webhook/new-ticket')` in `server.js`:
       - Import `crypto`.
       - Check for `x-nios4-signature` header (or similar).
       - If present, verify payload using `crypto.createHmac('sha256', process.env.WEBHOOK_SECRET).update(JSON.stringify(req.body)).digest('hex')`.
       - Map Nios4 payload (likely fields like `id_referenza`, `cliente`, `oggetto`, `gguid`) to the format expected by the client.
       - Emit `new-ticket` via Socket.io.
  </action>
  <verify>
    Run a test script that sends a signed POST request to `/webhook/new-ticket` and verify the server accepts it and logs the mapped payload.
  </verify>
  <done>
    Webhook endpoint is secured and correctly maps Nios4 data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Polling Fallback Implementation</name>
  <files>server.js</files>
  <action>
    Implement a polling service in `server.js`:
    1. Define a `Set` called `processedTickets` to store `gguid`s already notified.
    2. Create a function `runPolling()` that:
       - Calls `nios4.find_records('ticket', "stato='Aperto'")`.
       - Filters out tickets whose `gguid` is in `processedTickets`.
       - For each new ticket:
         - Adds `gguid` to `processedTickets`.
         - Emits `new-ticket` via Socket.io.
    3. Initialize the polling interval based on `process.env.POLLING_INTERVAL_MS` if `process.env.ENABLE_POLLING` is 'true'.
  </action>
  <verify>
    Set `POLLING_INTERVAL_MS` to a short value (e.g., 5000), mock the Nios4 response in `Nios4Client` or temporarily in `server.js`, and verify that `new-ticket` is emitted only once for the same `gguid`.
  </verify>
  <done>
    Polling fallback is active and correctly deduplicates tickets.
  </done>
</task>

<task type="auto">
  <name>Task 3: Server Verification</name>
  <files>test-nios-integration.js</files>
  <action>
    Create a verification script `test-nios-integration.js` that:
    1. Simulates a valid signed webhook request.
    2. Simulates an invalid signed webhook request (should be rejected/ignored).
    3. Mocks `Nios4Client.find_records` to return a sample ticket and verifies polling picks it up.
  </action>
  <verify>
    `node test-nios-integration.js` passes.
  </verify>
  <done>
    Integration logic is verified via automated script.
  </done>
</task>

</tasks>

<verification>
Check server logs for successful webhook signature verification and periodic polling activity.
</verification>

<success_criteria>
- Server rejects unsigned/invalidly signed webhooks (if secret is set).
- Server successfully maps Nios4 payloads.
- Background polling emits new tickets to Socket.io without duplicates.
</success_criteria>

<output>
After completion, create `.planning/phases/03-nios4-integration/03-01-SUMMARY.md`
</output>
