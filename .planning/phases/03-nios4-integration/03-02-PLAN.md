---
phase: 03-nios4-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: ["dispatcher.html"]
autonomous: false
requirements: [FR-4, FR-6]

must_haves:
  truths:
    - "UI correctly displays Nios4-specific fields (Cliente, Oggetto, Timing ID)"
    - "The 'Prendi in Carico' button opens the Nios4 deep-link with the correct GGUID"
    - "Production mode (non-mock) is enabled and communicating with the real server"
  artifacts:
    - path: "dispatcher.html"
      provides: "Updated UI for Nios4 integration"
  key_links:
    - from: "dispatcher.html"
      to: "server.js"
      via: "Socket.io and Fetch API"
---

<objective>
Update the frontend to correctly display Nios4 ticket data and implement the production deep-linking behavior. This transitions the UI from demonstration/mock mode to a functional integration.

Purpose: Provide technicians with accurate ticket information and a direct link to the Nios4 management system.
Output: Production-ready dispatcher UI.
</objective>

<execution_context>
@/home/laboratorio/.gemini/get-shit-done/workflows/execute-plan.md
@/home/laboratorio/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@dispatcher.html
@.planning/phases/03-nios4-integration/03-01-SUMMARY.md
</context>

<interfaces>
From server.js (as defined in Plan 01):
```javascript
// Expected Ticket Object format
{
  gguid: string,
  id_referenza: string,
  cliente: string,
  oggetto: string,
  data_apertura: string
}
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Nios4 UI Integration</name>
  <files>dispatcher.html</files>
  <action>
    1. Update `CONFIG` object:
       - Set `MOCK_MODE: false`.
       - Verify `D_TEC_URL_BASE` matches the verified pattern: `https://web.dtec.one/scheda/`.
    2. Simplify `socket.on('new-ticket')`:
       - Remove manual mapping if the server (from Plan 01) already sends the correct format.
       - Ensure `triggerAlertSequence(ticket)` receives the object directly.
    3. Update `triggerAlertSequence` and `appendTicketToLog` to consistently use Nios4 fields:
       - `cliente`
       - `oggetto`
       - `id_referenza` (displayed as Timing ID)
       - `data_apertura`
  </action>
  <verify>
    Verify that incoming tickets (via socket or poll) populate the UI fields correctly.
  </verify>
  <done>
    UI displays real Nios4 data and is no longer in mock mode.
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 2: End-to-End Visual Verification</name>
  <what-built>Full integration between Server (Polling/Webhook) and UI.</what-built>
  <how-to-verify>
    1. Ensure server is running (`npm start` or `node server.js`).
    2. Open `dispatcher.html` and click "Initialize System".
    3. Trigger a test event:
       - Either wait for polling to fetch a real ticket from Nios4.
       - Or use the `test-nios-integration.js` script to send a signed webhook.
    4. Verify:
       - Red alert screen appears.
       - Cliente and Oggetto match the test data.
       - Clicking "Prendi in Carico" opens the browser to `https://web.dtec.one/scheda/{gguid}`.
  </how-to-verify>
  <resume-signal>approved</resume-signal>
</task>

</tasks>

<verification>
Manual E2E check of the notification-to-acknowledgment flow.
</verification>

<success_criteria>
- Mock mode is disabled.
- Nios4 data fields are correctly rendered.
- Deep-links are correctly generated and functional.
</success_criteria>

<output>
After completion, create `.planning/phases/03-nios4-integration/03-02-SUMMARY.md`
</output>
