<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.M. Tecnology - Dispatcher Ticket</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e2d;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        /* Schermata iniziale per sbloccare l'audio */
        #start-screen {
            text-align: center;
        }

        .btn-start {
            background-color: #00a8ff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 168, 255, 0.4);
            transition: 0.3s;
        }

        .btn-start:hover {
            background-color: #0097e6;
        }

        /* Status di ascolto */
        #listening-screen {
            display: none;
            text-align: center;
        }

        .pulse {
            width: 20px;
            height: 20px;
            background-color: #4cd137;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 10px #4cd137;
            animation: pulsing 1.5s infinite;
        }

        @keyframes pulsing {
            0% {
                transform: scale(0.9);
                opacity: 0.7;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: scale(0.9);
                opacity: 0.7;
            }
        }

        /* MODALE BLOCCANTE TICKET URGENTE */
        #ticket-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(220, 20, 60, 0.95);
            /* Rosso Allarme */
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #ticket-modal h1 {
            font-size: 50px;
            margin-bottom: 10px;
        }

        #ticket-modal h2 {
            font-size: 30px;
            font-weight: normal;
            margin-bottom: 40px;
        }

        #countdown-box {
            font-size: 80px;
            font-weight: bold;
            background: white;
            color: #dc143c;
            padding: 20px 40px;
            border-radius: 15px;
            margin-bottom: 40px;
        }

        .btn-claim {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 25px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: 0.2s;
        }

        .btn-claim:hover {
            background-color: #2ecc71;
            transform: scale(1.05);
        }
    </style>
</head>

<body>

    <div id="start-screen">
        <h2>Pannello Dispatcher A.M. Tecnology</h2>
        <p>Premi il pulsante per attivare l'ascolto e sbloccare i suoni di allarme.</p>
        <button class="btn-start" onclick="avviaDispatcher()">Avvia Ascolto Ticket</button>
    </div>

    <div id="listening-screen">
        <div class="pulse"></div>
        <h2>In ascolto per nuovi ticket...</h2>
        <p>Non chiudere questa scheda. I popup appariranno automaticamente.</p>
    </div>

    <div id="ticket-modal">
        <h1>ðŸš¨ NUOVA RICHIESTA ASSISTENZA ðŸš¨</h1>
        <h2 id="modal-ticket-title">Cliente: Caricamento...</h2>
        <div id="countdown-box">10</div>
        <button class="btn-claim" onclick="prendiInCaricoAzione()">PRENDI IN CARICO</button>
    </div>

    <script>
        // ==========================================
        // CONFIGURAZIONE API NIOS4 (DA MODIFICARE CON I TUOI DATI)
        // ==========================================
        const API_BASE_URL = "https://web.nios4.com/ws";
        const TOKEN_NIOS4 = "e9b5ddc844acd1456416971d3145e2ca"; // Token di accesso alle API
        const DATABASE_ID = "dtec3701";
        const TABLE_NOME = "ticket"; // Cambia se in D-TEC la tabella si chiama diversamente
        const NOME_OPERATORE = "57684"; // Cambia per ogni tecnico (o id del tecnico)
        const AUDIO_URL = "https://actions.google.com/sounds/v1/alarms/beep_short.ogg"; // Suono di allarme generico

        // Variabili di stato
        let pollingInterval;
        let countdownInterval;
        let ticketCorrenteGguid = null;
        const allarmeAudio = new Audio(AUDIO_URL);
        allarmeAudio.loop = true; // Continua a suonare finchÃ© non si chiude

        // 1. Inizializzazione
        function avviaDispatcher() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('listening-screen').style.display = 'block';

            // Sblocca le policy audio del browser riproducendo e mettendo subito in pausa
            allarmeAudio.play().then(() => { allarmeAudio.pause(); }).catch(e => console.log(e));

            // Inizia il polling ogni 3 secondi
            pollingInterval = setInterval(controllaNuoviTicket, 3000);
            console.log("Dispatcher avviato.");
        }

        // 2. Controllo nuovi Ticket via API (Il Polling)
        async function controllaNuoviTicket() {
            try {
                // Cerchiamo ticket con stato 'Nuovo'
                const filterUrl = encodeURIComponent("stato='Nuovo'");
                const response = await fetch(`${API_BASE_URL}/model?database=${DATABASE_ID}&table=${TABLE_NOME}&filter=${filterUrl}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${TOKEN_NIOS4}` }
                });

                const data = await response.json();

                if (data.records && data.records.length > 0) {
                    const ticketTrovato = data.records[0];

                    // Se non stiamo giÃ  gestendo questo ticket
                    if (ticketCorrenteGguid !== ticketTrovato.gguid) {
                        mostraAllarme(ticketTrovato);
                    }
                } else {
                    // Se non ci sono ticket nuovi, ma il modale Ã¨ aperto, significa che 
                    // un altro collega l'ha preso! Dobbiamo chiudere il modale.
                    if (ticketCorrenteGguid !== null) {
                        chiudiModale("Il ticket Ã¨ stato preso in carico da un collega!");
                    }
                }
            } catch (error) {
                console.error("Errore di connessione a Nios4:", error);
            }
        }

        // 3. Mostra il Modale e avvia il countdown
        function mostraAllarme(ticket) {
            ticketCorrenteGguid = ticket.gguid;

            // Suona!
            allarmeAudio.play();

            // Aggiorna grafica
            document.getElementById('modal-ticket-title').innerText = ticket.oggetto || "Nuovo Ticket dal Sito";
            document.getElementById('ticket-modal').style.display = 'flex';

            let secondiRimasti = 10;
            document.getElementById('countdown-box').innerText = secondiRimasti;

            // Timer di 10 secondi
            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                secondiRimasti--;
                document.getElementById('countdown-box').innerText = secondiRimasti;

                if (secondiRimasti <= 0) {
                    prendiInCaricoAzione(); // Scaduto il tempo, prende il ticket in automatico
                }
            }, 1000);
        }

        // 4. Azione "Prendi in Carico"
        async function prendiInCaricoAzione() {
            clearInterval(countdownInterval);
            allarmeAudio.pause();
            allarmeAudio.currentTime = 0;
            document.getElementById('ticket-modal').style.display = 'none';

            const payload = {
                database: DATABASE_ID,
                table: TABLE_NOME,
                data: [{
                    gguid: ticketCorrenteGguid,
                    stato: "In Lavorazione", // Aggiorna lo stato
                    operatore: NOME_OPERATORE // Assegna l'operatore
                }]
            };

            try {
                // Salva il record
                await fetch(`${API_BASE_URL}/table_save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN_NIOS4}`
                    },
                    body: JSON.stringify(payload)
                });

                // Lancia il comando Sync a Nios4 per aggiornare tutti i client
                await fetch(`${API_BASE_URL}/sync?database=${DATABASE_ID}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${TOKEN_NIOS4}` }
                });

                // Apri la scheda del ticket in D-TEC (Adatta l'URL al tuo D-TEC)
                window.open(`https://web.dtec.one/scheda/${ticketCorrenteGguid}`, '_blank');

                // Resetta la sentinella
                ticketCorrenteGguid = null;

            } catch (error) {
                alert("Errore durante la presa in carico. Riprova.");
                console.error(error);
                ticketCorrenteGguid = null; // Sblocca
            }
        }

        // 5. Funzione di utilitÃ  per chiudere il modale (es. se un altro tecnico ci anticipa)
        function chiudiModale(messaggio) {
            clearInterval(countdownInterval);
            allarmeAudio.pause();
            allarmeAudio.currentTime = 0;
            document.getElementById('ticket-modal').style.display = 'none';
            ticketCorrenteGguid = null;

            // Opzionale: mostra un piccolo avviso
            console.log(messaggio);
        }
    </script>
</body>

</html>