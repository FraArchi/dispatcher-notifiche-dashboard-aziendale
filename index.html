<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.M. Tecnology - Dispatcher Ticket</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e2d;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #start-screen {
            text-align: center;
        }

        .btn-start {
            background-color: #00a8ff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 168, 255, 0.4);
            transition: 0.3s;
        }

        .btn-start:hover {
            background-color: #0097e6;
        }

        #listening-screen {
            display: none;
            text-align: center;
        }

        .pulse {
            width: 20px;
            height: 20px;
            background-color: #4cd137;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 10px #4cd137;
            animation: pulsing 1.5s infinite;
        }

        @keyframes pulsing {
            0% {
                transform: scale(0.9);
                opacity: 0.7;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: scale(0.9);
                opacity: 0.7;
            }
        }

        /* MODALE BLOCCANTE TICKET URGENTE */
        #ticket-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(220, 20, 60, 0.95);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #ticket-modal h1 {
            font-size: 50px;
            margin-bottom: 10px;
        }

        #ticket-modal h2 {
            font-size: 30px;
            font-weight: normal;
            margin-bottom: 40px;
        }

        #countdown-box {
            font-size: 80px;
            font-weight: bold;
            background: white;
            color: #dc143c;
            padding: 20px 40px;
            border-radius: 15px;
            margin-bottom: 40px;
        }

        .btn-claim {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 25px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transition: 0.2s;
        }

        .btn-claim:hover {
            background-color: #2ecc71;
            transform: scale(1.05);
        }
    </style>
</head>

<body>

    <div id="start-screen">
        <h2>Pannello Dispatcher A.M. Tecnology</h2>
        <p>Premi il pulsante per attivare l'ascolto e sbloccare i suoni di allarme.</p>
        <button class="btn-start" onclick="avviaDispatcher()">Avvia Ascolto Ticket</button>
    </div>

    <div id="listening-screen">
        <div class="pulse"></div>
        <h2>In ascolto per nuovi ticket...</h2>
        <p>Non chiudere questa scheda. I popup appariranno automaticamente.</p>
    </div>

    <div id="ticket-modal">
        <h1>ðŸš¨ NUOVA RICHIESTA ASSISTENZA ðŸš¨</h1>
        <h2 id="modal-ticket-title">Caricamento...</h2>
        <div id="countdown-box">10</div>
        <button class="btn-claim" onclick="prendiInCaricoAzione()">VAI AL TICKET</button>
    </div>

    <script>
        // ==========================================
        // CONFIGURAZIONE API NIOS4 
        // ==========================================
        const API_BASE_URL = "https://web.nios4.com/ws";
        const TOKEN_NIOS4 = "e9b5ddc844acd1456416971d3145e2ca";
        const DATABASE_ID = "dtec3701";
        const TABLE_NOME = "ticket";
        const AUDIO_URL = "https://actions.google.com/sounds/v1/alarms/beep_short.ogg";

        // Variabili di stato
        let pollingInterval;
        let countdownInterval;
        let ticketCorrenteGguid = null;
        let ticketGiaNotificati = []; // Memoria per non far suonare due volte lo stesso ticket

        const allarmeAudio = new Audio(AUDIO_URL);
        allarmeAudio.loop = true;

        // 1. Inizializzazione
        function avviaDispatcher() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('listening-screen').style.display = 'block';

            // Sblocca le policy audio del browser
            allarmeAudio.play().then(() => { allarmeAudio.pause(); }).catch(e => console.log(e));

            // Inizia il polling ogni 3 secondi
            pollingInterval = setInterval(controllaNuoviTicket, 3000);
            console.log("Dispatcher avviato.");
        }

        // 2. Controllo nuovi Ticket via API (Senza Headers per eludere il CORS preflight)
        async function controllaNuoviTicket() {
            try {

                const response = await fetch(`http://localhost:3000/api/ticket`);

                const data = await response.json();

                if (data.records && data.records.length > 0) {
                    const ticketNuovo = data.records.find(t => !ticketGiaNotificati.includes(t.gguid));

                    if (ticketNuovo && ticketCorrenteGguid === null) {
                        mostraAllarme(ticketNuovo);
                    }
                }
            } catch (error) {
                console.error("Errore di connessione a Nios4:", error);
            }
        }

        // 3. Mostra il Modale
        function mostraAllarme(ticket) {
            ticketCorrenteGguid = ticket.gguid;

            // Lo aggiungiamo subito alla lista dei giÃ  visti
            ticketGiaNotificati.push(ticket.gguid);

            // Suona!
            allarmeAudio.play().catch(e => console.error("Audio bloccato:", e));

            // Aggiorna interfaccia
            const nomeCliente = ticket.cliente || "Sconosciuto";
            const idTicket = ticket.id_ticket || "---";
            document.getElementById('modal-ticket-title').innerText = `Ticket #${idTicket} - Cliente: ${nomeCliente}`;
            document.getElementById('ticket-modal').style.display = 'flex';

            let secondiRimasti = 10;
            document.getElementById('countdown-box').innerText = secondiRimasti;

            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                secondiRimasti--;
                document.getElementById('countdown-box').innerText = secondiRimasti;

                if (secondiRimasti <= 0) {
                    chiudiModaleSilenziosamente(); // Scaduto il tempo, smette di suonare
                }
            }, 1000);
        }

        // 4. Azione "Prendi in Carico / Vai al Ticket"
        function prendiInCaricoAzione() {
            const gguidDaAprire = ticketCorrenteGguid;
            chiudiModaleSilenziosamente();

            // Apre semplicemente la scheda su D-TEC (lasciando l'operatore libero di modificarla)
            window.open(`https://web.dtec.one/scheda/${gguidDaAprire}`, '_blank');
        }

        // 5. Funzione di chiusura
        function chiudiModaleSilenziosamente() {
            clearInterval(countdownInterval);
            allarmeAudio.pause();
            allarmeAudio.currentTime = 0;
            document.getElementById('ticket-modal').style.display = 'none';
            ticketCorrenteGguid = null; // Sblocca il sistema per futuri allarmi
        }
    </script>
</body>

</html>